#!/bin/bash


PSQL="psql --username=freecodecamp --dbname=number_guess -t --no-align -c"

echo -e "Enter your username:"
read USERNAME

DB_USERNAME=$($PSQL "SELECT * FROM users WHERE username = '$USERNAME';")
GAMES_PLAYED=$($PSQL "SELECT games_played FROM users WHERE username = '$USERNAME';")
BEST_GAME=$($PSQL "SELECT best_game FROM users WHERE username = '$USERNAME';")

if [[ -z $DB_USERNAME ]]
then

echo $($PSQL "INSERT INTO users(username, games_played, best_game) VALUES ('$USERNAME', 0, 0);")
echo -e "Welcome, $USERNAME! It looks like this is your first time here."

else

echo $DB_USERNAME | while IFS="|" read NAME GAMES BEST
do
echo -e "Welcome back, $NAME! You have played $GAMES games, and your best game took $BEST guesses."
done

fi

RANDOM_NUMBER=$((RANDOM%1000))
COUNT_GUESSES=0

echo -e "Guess the secret number between 1 and 1000:"
read GUESS

RUN_GAME=true

until [[ $RUN_GAME == false ]]
do
if ! [[ $GUESS =~ ^[0-9]+$ ]]
then
echo -e "That is not an integer, guess again:"
read GUESS

elif [[ $GUESS -gt $RANDOM_NUMBER ]]
then
COUNT_GUESSES=$(($COUNT_GUESSES + 1))
echo -e "It's lower than that, guess again:"
read GUESS

elif [[ $GUESS -lt $RANDOM_NUMBER ]]
then
COUNT_GUESSES=$(($COUNT_GUESSES + 1))
echo -e "It's higher than that, guess again:"
read GUESS

else
GAMES_PLAYED=$(($GAMES_PLAYED + 1))
COUNT_GUESSES=$(($COUNT_GUESSES + 1))

echo $($PSQL "UPDATE users SET games_played = $GAMES_PLAYED WHERE username = '$USERNAME';")

if [[ $BEST_GAME -eq 0 ]]
then 
echo $($PSQL "UPDATE users SET best_game = $COUNT_GUESSES WHERE username = '$USERNAME';")
elif [[ $COUNT_GUESSES -lt $BEST_GAME ]]
then
echo $($PSQL "UPDATE users SET best_game = $COUNT_GUESSES WHERE username = '$USERNAME';")
fi
echo -e "You guessed it in $COUNT_GUESSES tries. The secret number was $RANDOM_NUMBER. Nice job!"
RUN_GAME=false
fi
done